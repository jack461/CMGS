
GM_Log("T08-Start");

var str = stralloc();
var sgt = stralloc();

sprintf(str, "THrID = %.0f", thread(`idt));
GM_Log(str);

function xthread()
(
    sprintf(sgt, "Sub THrd-%.0f-start", thread(`idt));
    GM_Log(sgt);

    wait(20 + rand(120));
    sprintf(sgt, "Sub THrd-%.0f-end", thread(`idt));
    GM_Log(sgt);
);

var thr1 = thread(`new, xthread);
var thr2 = thread(`new, xthread);
var thr3 = thread(`new, xthread);
var thr4 = thread(`new, xthread);

thread(`run, thr1);
thread(`run, thr2);
thread(`run, thr3);
thread(`run, thr4);

yield();

var lp = 1, cnt = 0;

while (lp) (
    ((thread(`status, thr1) == 0) && (thread(`status, thr2) == 0) &&
     (thread(`status, thr3) == 0) && (thread(`status, thr4) == 0)) ? (
        lp = 0;
    );
    wait(1);
    cnt += 1;
    (cnt > 240) ? (
        GM_Log("Some threads not terminated");
        sprintf(sgt, "%d %d %d %d", thread(`status, thr1), thread(`status, thr2),
            thread(`status, thr3), thread(`status, thr4));
        GM_Log(sgt);
        exit(0);
    );
);

GM_Log("All threads terminated");

strfree(str);
strfree(sgt);
//=============================================================//