/*
    Play selected clip (in clip selection, by right-click)
*/

var s = stralloc();
var k;

// ceci fournit le numéro du clip sélectionné
var clip = get(`gm, `cellAlt);

// trace
sprintf(s, "Test 30 - Start - Clip %04d", clip); GM_Log(s);

// récupération de quelques variables système 
var stat = get(`gm, `cbStat);

// sprintf(s, "    vars: %d, clip: %04d", stat, clip); GM_Log(s);

// jeu du clip. `unit demande à récupérer comme résultat l'adresse de l'unité (le player) qui a joué le clip
var U = play(`clip, clip, `unit);

wait(0.1);

// sprintf(s, "Unit = %d", U); GM_Log(s);

// on boucle en attente de l'initialisation du jeu
//    au lieu de "3", on peut écrire "uSStarting" après avoir défini:
//    var uSStarting = get(`gm, `uSStarting);
while ((k = gmem[U + stat]) === 3) (
   wait(0.1);
);

wait(1);

// ceci récupère l'état du player
k = gmem[U + stat];
//sprintf(s, "    status = %d", k); GM_Log(s);


// Is the clip actually playing ?
//    au lieu de "258", on peut écrire "uSBusy" après avoir défini:
//    var uSBusy = get(`gm, `uSBusy);
(k === 258) ? (
    // On relance 5 fois le clip
    loop(5,
        wait(14);
        U = play(`clip, clip, `unit);
        wait(1);
    );
    
    // On boucle tant que le dernier clip est
    // en train de jouer
    while ((k = gmem[U + stat]) === 258) (
        wait(1);
    );
);

GM_Log("Test 30 - End.", " ");

strfree(s);
