var id = "T12";
var stopbit = 0x100;

var str = stralloc();

var w2 = sprintf(0, "%s  started", id); GM_Log(w2);

var snds = data(
// Quelques clips courts...
0 1 2 3 4 5 6 7 8 9 10 11 12 
16 17 18 19 20 21 22 23 27 28 32 33
1001 1003 1009 1012 2780 1101 1000 2791 2201 8009 8024 2361
8047 3414 3416 1103 2300 8046 8033 8027 8032 2788 8038 2302
2756 8026 8028 8041 2606 8010 2918 2315 2607 3153 3143 8029
2362 2355 3203 2608 2747 2366 3240 2609 1007 3144 2331 1004

4200 4201 4202 4203 4204 4205 4206 4207 4208 4209
4210 4211 4212 4213 4214 4215 4216 4217 4218 4219
4220 4221 4222 4223 4224
);
var sndsz = snds[-1];

var longsnds = data (
// Quelques clips longs /3 ou 4 '
4300 4301 4302 4303 4304 4305 4306
4350 4351 4352 4353 4354 4355 4356 4357 4358 4358 4360 4361
);


var pnum = 0;
var flg = 1;
var longplay = 1;

function doMIDI(xn)
local (ipca, dbg, pn)
(
    ipca = event(); 
    flg = 1;
    while(flg) (
        dbg = SYSFlgs[0];
        (dbg & stopbit) ? (
            sprintf(str, "THRD%d  : about to stop.", xn); GM_Log(str);
            flg = 0;
        ) : (
            (dbg & 1) ? (
                sprintf(str, "THRD%d  : going to wait.", xn); GM_Log(str);
            );
            event(`wait, `MIDI);
            (dbg & 2) ? (
                sprintf(str, "THRD%d ==> %d: %s  %d  %d  %d  %d", xn, ipca[0], edn(0, ipca[14]),
                    ipca[15], ipca[16], ipca[17]); GM_Log(str);
            );
            ((ipca[14] == `MIDI) && ((ipca[16] & 0xF0) == 144) && ((dbg & stopbit) == 0)) ? (
                // got a "note on"
                longplay ? (
                    longplay = 0;
                    pn = longsnds[rand(longsnds[-1])];
                    play(`clip, pn, `vol, -8, `spmode, 2);
                ) : (
                    pn = snds[rand(sndsz)];
                    play(`clip, pn);
                );
                sprintf(str, "THRD%d  : Play clip: %d.", xn, pn); GM_Log(str);
            );
        );
    );
);

function MainThr()
(
   pnum = pnum + 1;
   doMIDI(pnum);
);


function longdo()
(
    flg = 1;
    while(flg) (
        wait(135);
        longplay = 1;
    );
);


loop(8,
    wait(1);
    thread(`run, thread(`new, MainThr));
);

thread(`run, thread(`new, longdo));

wait(30);

sprintf(str, "%s  ended", id); GM_Log(str);

